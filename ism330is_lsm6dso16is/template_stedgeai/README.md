## 1 - Introduction

This is a template for integrating the code generated by [ST Edge AI Core](https://www.st.com/en/development-tools/stedgeai-core.html), a tool which can be used to convert neural network models into implementations optimized for the ISPU.

The *ispu* folder may be copied by itself (no dependencies other than the CLI toolchain or IDE environment that must be installed) and used as a starting project to integrate any model converted using ST Edge AI Core.


## 2 - Model implementation generation

The template project is structured so that ST Edge AI Core can automatically populate it with the necessary files in the right places. In order to achieve that, from within the *ispu* folder, run the following command:

```shell
stedgeai generate --target ispu --no-workspace --no-report -m <nn_model_file> --output .
```

where *nn_model_file* is the file containing the model of the neural network to convert. Of course, additional options can be added to the *generate* command above as needed.

In alternative, [MEMS-Studio](https://www.st.com/en/development-tools/mems-studio.html)'s ISPU Model Converter can be used to generate the network code, specifying the *ispu* folder as output directory. The [ST Edge AI Developer Cloud](https://www.st.com/en/development-tools/stedgeai-dc.html) can also be used to generate and download the converted code.


## 3 - Integration of the model

Once the code has been generated, the project will build, but it will output a number of warnings. Their purpose is to alert to the fact that, in order to complete the integration of the neural network model in the ISPU code, a few modifications specific to the model and the use-case in *ispu/src/main.c* are necessary:

* Implement the logic necessary to fill the input data buffer and run the inference when ready.

  ```c
  void __attribute__ ((signal)) algo_00(void)
  {
      #warning "Fill the input data buffers contained in input_buffers."
      #warning "Each buffer in input_buffers must be cast to the appropriate type before accessing it."

      #warning "The network inference must be run when the input data buffers are ready."
      stai_return_code res = stai_network_run(net, STAI_MODE_SYNC);
  ```
  Note that each element of `input_buffers` is a pointer to void and contains the memory address of one input buffer. In order to access an input buffer to fill it in with data it must be first cast to a pointer of the correct type for that input. For example, if the first input buffer has to be filled in with float values:
  ```c
  float *input = (float *)input_buffers[0];
  ```
  In this way, `input` can be treated as an array of float values and used normally.

* (Optional) Implement a logic to handle errors returned by the inference.

  ```c
      stai_return_code res = stai_network_run(net, STAI_MODE_SYNC);
      if (res >= STAI_ERROR_GENERIC) {
          #warning "Handle inference error as deemed appropriate."
      }
  ```

* Retrieve the neural network results from the output data buffer and generate the interrupt as needed.

  ```c
      #warning "Get the inference results from the output data buffers contained in output_buffers."
      #warning "Each buffer in output_buffers must be cast to the appropriate type before accessing it."

      // interrupt generation
      int_status = int_status | 0x1u;
  ```
  Note that each element of `output_buffers` is a pointer to void and contains the memory address of one output buffer. In order to access an output buffer to read the results it must be first cast to a pointer of the correct type for that output. For example, if the first output buffer contains 8-bit signed integer values:
  ```c
  int8_t *output = (int8_t *)output_buffers[0];
  ```
  In this way, `output` can be treated as an array of int8_t values and used normally.

Besides *ispu/src/main.c*, also *ispu/conf.txt* should be modified to set the required sensor settings.

------

**More Information: [http://www.st.com](http://st.com/MEMS)**

**Copyright Â© 2024 STMicroelectronics**
